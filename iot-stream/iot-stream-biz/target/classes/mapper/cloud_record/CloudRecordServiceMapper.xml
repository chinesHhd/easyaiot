<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.basiclab.iot.stream.mapper.CloudRecordServiceMapper">

    <!-- 添加云录制记录 (PostgreSQL 优化) -->
    <insert id="add" parameterType="com.basiclab.iot.stream.service.bean.CloudRecordItem">
        INSERT INTO wvp_cloud_record (
        app,
        stream,
        <if test="callId != null">call_id,</if>
        start_time,
        end_time,
        media_server_id,
        file_name,
        folder,
        file_path,
        file_size,
        server_id,
        time_len
        ) VALUES (
        #{app},
        #{stream},
        <if test="callId != null">#{callId},</if>
        #{startTime},
        #{endTime},
        #{mediaServerId},
        #{fileName},
        #{folder},
        #{filePath},
        #{fileSize},
        #{serverId},
        #{timeLen}
        )
    </insert>

    <!-- 查询录制记录列表 (PostgreSQL 优化) -->
    <select id="getList" resultType="com.basiclab.iot.stream.service.bean.CloudRecordItem">
        SELECT *
        FROM wvp_cloud_record
        WHERE 1 = 1
        <if test="query != null and query != ''">
            AND (app LIKE '%' || #{query} || '%' ESCAPE '/'
            OR stream LIKE '%' || #{query} || '%' ESCAPE '/')
        </if>
        <if test="app != null">
            AND app = #{app}
        </if>
        <if test="stream != null">
            AND stream = #{stream}
        </if>
        <if test="startTimeStamp != null">
            AND end_time &gt;= #{startTimeStamp}
        </if>
        <if test="endTimeStamp != null">
            AND start_time &lt;= #{endTimeStamp}
        </if>
        <if test="callId != null">
            AND call_id = #{callId}
        </if>
        <if test="mediaServerItemList != null and mediaServerItemList.size() > 0">
            AND media_server_id IN
            <foreach collection="mediaServerItemList" item="item" open="(" separator="," close=")">
                #{item.id}
            </foreach>
        </if>
        <if test="ids != null and ids.size() > 0">
            AND id IN
            <foreach collection="ids" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <choose>
            <when test="ascOrder != null and ascOrder">
                ORDER BY start_time ASC
            </when>
            <otherwise>
                ORDER BY start_time DESC
            </otherwise>
        </choose>
    </select>

    <!-- 查询录制文件路径列表 (PostgreSQL 优化) -->
    <select id="queryRecordFilePathList" resultType="java.lang.String">
        SELECT file_path
        FROM wvp_cloud_record
        WHERE 1 = 1
        <if test="app != null">
            AND app = #{app}
        </if>
        <if test="stream != null">
            AND stream = #{stream}
        </if>
        <if test="startTimeStamp != null">
            AND end_time &gt;= #{startTimeStamp}
        </if>
        <if test="endTimeStamp != null">
            AND start_time &lt;= #{endTimeStamp}
        </if>
        <if test="callId != null">
            AND call_id = #{callId}
        </if>
        <if test="mediaServerItemList != null and mediaServerItemList.size() > 0">
            AND media_server_id IN
            <foreach collection="mediaServerItemList" item="item" open="(" separator="," close=")">
                #{item.id}
            </foreach>
        </if>
    </select>

    <!-- 批量更新收藏状态 (PostgreSQL 优化) -->
    <update id="updateCollectList">
        UPDATE wvp_cloud_record
        SET collect = #{collect}
        WHERE file_path IN
        <foreach collection="cloudRecordItemList" item="item" open="(" separator="," close=")">
            #{item.filePath}
        </foreach>
    </update>

    <!-- 根据文件列表删除记录 (PostgreSQL 优化) -->
    <delete id="deleteByFileList">
        DELETE FROM wvp_cloud_record
        WHERE media_server_id = #{mediaServerId}
        AND file_path IN
        <foreach collection="filePathList" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <!-- 查询待删除的录制记录 (PostgreSQL 优化) -->
    <select id="queryRecordListForDelete" resultType="com.basiclab.iot.stream.service.bean.CloudRecordItem">
        SELECT *
        FROM wvp_cloud_record
        WHERE collect = false
          AND end_time &lt;= #{endTimeStamp}
          AND media_server_id = #{mediaServerId}
    </select>

    <!-- 更新单条记录的收藏状态 -->
    <update id="changeCollectById">
        UPDATE wvp_cloud_record
        SET collect = #{collect}
        WHERE id = #{recordId}
    </update>

    <!-- 批量删除录制记录 (PostgreSQL 优化) -->
    <delete id="deleteList">
        DELETE FROM wvp_cloud_record
        WHERE id IN
        <foreach collection="cloudRecordItemIdList" item="item" open="(" separator="," close=")">
            #{item.id}
        </foreach>
    </delete>

    <!-- 根据呼叫ID查询录制记录 -->
    <select id="getListByCallId" resultType="com.basiclab.iot.stream.service.bean.CloudRecordItem">
        SELECT *
        FROM wvp_cloud_record
        WHERE call_id = #{callId}
    </select>

    <!-- 根据ID查询单条录制记录 -->
    <select id="queryOne" resultType="com.basiclab.iot.stream.service.bean.CloudRecordItem">
        SELECT *
        FROM wvp_cloud_record
        WHERE id = #{id}
    </select>

    <!-- 查询媒体服务器ID列表 (PostgreSQL 优化) -->
    <select id="queryMediaServerId" resultType="java.lang.String">
        SELECT media_server_id
        FROM wvp_cloud_record
        WHERE 1 = 1
        <if test="app != null">
            AND app = #{app}
        </if>
        <if test="stream != null">
            AND stream = #{stream}
        </if>
        <if test="startTimeStamp != null">
            AND end_time &gt;= #{startTimeStamp}
        </if>
        <if test="endTimeStamp != null">
            AND start_time &lt;= #{endTimeStamp}
        </if>
        GROUP BY media_server_id
    </select>

    <!-- 根据ID集合查询录制记录 (PostgreSQL 优化) -->
    <select id="queryRecordByIds" resultType="com.basiclab.iot.stream.service.bean.CloudRecordItem">
        SELECT *
        FROM wvp_cloud_record
        WHERE id IN
        <foreach collection="ids" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

</mapper>
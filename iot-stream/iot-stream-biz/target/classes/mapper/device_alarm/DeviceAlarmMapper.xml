<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.basiclab.iot.stream.mapper.DeviceAlarmMapper">

    <!-- 添加设备报警 (PostgreSQL) -->
    <insert id="add" parameterType="com.basiclab.iot.stream.bean.DeviceAlarm">
        INSERT INTO wvp_device_alarm (
            device_id, channel_id, alarm_priority, alarm_method, alarm_time,
            alarm_description, longitude, latitude, alarm_type, create_time
        ) VALUES (
                     #{deviceId}, #{channelId}, #{alarmPriority}, #{alarmMethod},
                     TO_TIMESTAMP(#{alarmTime}, 'YYYY-MM-DD HH24:MI:SS'),
                     #{alarmDescription}, #{longitude}, #{latitude}, #{alarmType},
                     TO_TIMESTAMP(#{createTime}, 'YYYY-MM-DD HH24:MI:SS')
                 )
    </insert>

    <!-- 查询设备报警 (PostgreSQL) -->
    <select id="query" resultType="com.basiclab.iot.stream.bean.DeviceAlarm">
        SELECT *
        FROM wvp_device_alarm
        WHERE 1 = 1
        <if test="deviceId != null and deviceId != ''">
            AND device_id = #{deviceId}
        </if>
        <if test="alarmPriority != null and alarmPriority != ''">
            AND alarm_priority = #{alarmPriority}
        </if>
        <if test="alarmMethod != null and alarmMethod != ''">
            AND alarm_method = #{alarmMethod}
        </if>
        <if test="alarmType != null and alarmType != ''">
            AND alarm_type = #{alarmType}
        </if>
        <if test="startTime != null and startTime != ''">
            AND alarm_time &gt;= TO_TIMESTAMP(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
        </if>
        <if test="endTime != null and endTime != ''">
            AND alarm_time &lt;= TO_TIMESTAMP(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')
        </if>
        ORDER BY alarm_time ASC
    </select>

    <!-- 清除过期报警 (PostgreSQL) -->
    <delete id="clearAlarmBeforeTime">
        DELETE FROM wvp_device_alarm
        WHERE 1 = 1
        <choose>
            <when test="id != null">
                AND id = #{id}
            </when>
            <otherwise>
                <if test="deviceIdList != null and deviceIdList.size() > 0">
                    AND device_id IN
                    <foreach collection="deviceIdList" item="item" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="time != null and time != ''">
                    AND alarm_time &lt;= TO_TIMESTAMP(#{time}, 'YYYY-MM-DD HH24:MI:SS')
                </if>
            </otherwise>
        </choose>
    </delete>

</mapper>
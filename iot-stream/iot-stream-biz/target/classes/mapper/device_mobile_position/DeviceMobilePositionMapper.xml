<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.basiclab.iot.stream.mapper.DeviceMobilePositionMapper">

    <!-- 单条位置记录插入 -->
    <insert id="insertNewPosition" parameterType="com.basiclab.iot.stream.bean.MobilePosition">
        INSERT INTO wvp_device_mobile_position (
            device_id, channel_id, device_name, time, longitude, latitude,
            altitude, speed, direction, report_source, create_time
        ) VALUES (
                     #{deviceId}, #{channelId}, #{deviceName}, #{time}, #{longitude},
                     #{latitude}, #{altitude}, #{speed}, #{direction},
                     #{reportSource}, #{createTime}
                 )
    </insert>

    <!-- 按条件查询位置记录 (带动态条件) -->
    <select id="queryPositionByDeviceIdAndTime" resultType="com.basiclab.iot.stream.bean.MobilePosition">
        SELECT * FROM wvp_device_mobile_position
        WHERE device_id = #{deviceId}
        <if test="channelId != null">
            AND channel_id = #{channelId}
        </if>
        <if test="startTime != null">
            AND time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND time &lt;= #{endTime}
        </if>
        ORDER BY time ASC
    </select>

    <!-- 查询设备最新位置 -->
    <select id="queryLatestPositionByDevice" resultType="com.basiclab.iot.stream.bean.MobilePosition">
        SELECT * FROM wvp_device_mobile_position
        WHERE device_id = #{deviceId}
        ORDER BY time DESC
            LIMIT 1
    </select>

    <!-- 清除设备所有位置记录 -->
    <delete id="clearMobilePositionsByDeviceId">
        DELETE FROM wvp_device_mobile_position
        WHERE device_id = #{deviceId}
    </delete>

    <!-- 批量插入位置记录 (PostgreSQL优化版) -->
    <insert id="batchadd" parameterType="java.util.List">
        INSERT INTO wvp_device_mobile_position (
        device_id, channel_id, device_name, time, longitude, latitude,
        altitude, speed, direction, report_source, create_time
        ) VALUES
        <foreach collection="mobilePositions" item="item" separator=",">
            (
            #{item.deviceId}, #{item.channelId}, #{item.deviceName}, #{item.time},
            #{item.longitude}, #{item.latitude}, #{item.altitude}, #{item.speed},
            #{item.direction}, #{item.reportSource}, #{item.createTime}
            )
        </foreach>
    </insert>

</mapper>
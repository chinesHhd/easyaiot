<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.basiclab.iot.stream.mapper.RegionMapper">

    <!-- 区域添加 -->
    <insert id="add" parameterType="Region" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO wvp_common_region (
            device_id, name, parent_id, parent_device_id, create_time, update_time
        ) VALUES (
                     #{deviceId}, #{name}, #{parentId}, #{parentDeviceId}, #{createTime}, #{updateTime}
                 )
    </insert>

    <!-- 区域删除 -->
    <delete id="delete">
        DELETE FROM wvp_common_region WHERE id = #{id}
    </delete>

    <!-- 区域更新 -->
    <update id="update" parameterType="Region">
        UPDATE wvp_common_region
        SET update_time = #{updateTime},
            device_id = #{deviceId},
            name = #{name},
            parent_id = #{parentId},
            parent_device_id = #{parentDeviceId}
        WHERE id = #{id}
    </update>

    <!-- 区域查询 -->
    <select id="query" resultType="Region">
        SELECT * FROM wvp_common_region
        <where>
            <if test="query != null">
                AND (device_id LIKE CONCAT('%', #{query}, '%') ESCAPE '/'
                OR name LIKE CONCAT('%', #{query}, '%') ESCAPE '/')
            </if>
            <if test="parentId != null">
                AND parent_device_id = #{parentId}
            </if>
        </where>
        ORDER BY id
    </select>

    <!-- 获取子区域 -->
    <select id="getChildren" resultType="Region">
        SELECT * FROM wvp_common_region
        WHERE parent_id = #{parentId}
        ORDER BY id
    </select>

    <!-- 根据ID查询区域 -->
    <select id="queryOne" resultType="Region">
        SELECT * FROM wvp_common_region
        WHERE id = #{id}
    </select>

    <!-- 获取未初始化的行政区划码 -->
    <select id="getUninitializedCivilCode" resultType="string">
        SELECT dc.civil_code AS civil_code
        FROM wvp_device_channel dc
        WHERE dc.civil_code NOT IN (
            SELECT device_id FROM wvp_common_region
        )
    </select>

    <!-- 批量查询存在的设备ID -->
    <select id="queryInList" resultType="string">
        SELECT device_id FROM wvp_common_region
        WHERE device_id IN
        <foreach collection="codes" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <!-- 批量添加区域 -->
    <insert id="batchAdd" parameterType="list" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO wvp_common_region (
        device_id, name, parent_device_id, parent_id, create_time, update_time
        ) VALUES
        <foreach collection="regionList" item="item" separator=",">
            (#{item.deviceId}, #{item.name}, #{item.parentDeviceId},
            #{item.parentId}, #{item.createTime}, #{item.updateTime})
        </foreach>
    </insert>

    <!-- 树形结构查询 -->
    <select id="queryForTree" resultType="RegionTree">
        SELECT *,
        CONCAT('region', id) AS tree_id,
        0 AS type,
        'ON' AS status,
        false AS is_leaf
        FROM wvp_common_region
        <where>
            <choose>
                <when test="parentId != null">
                    parent_id = #{parentId}
                </when>
                <otherwise>
                    parent_id IS NULL
                </otherwise>
            </choose>
            <if test="query != null">
                AND (device_id LIKE CONCAT('%', #{query}, '%') ESCAPE '/'
                OR name LIKE CONCAT('%', #{query}, '%') ESCAPE '/'
            </if>
        </where>
    </select>

    <!-- 批量删除 -->
    <delete id="batchDelete">
        DELETE FROM wvp_common_region
        WHERE id IN
        <foreach collection="allChildren" item="item" open="(" separator="," close=")">
            #{item.id}
        </foreach>
    </delete>

    <!-- 根据设备ID批量查询区域 -->
    <select id="queryInRegionListByDeviceId" resultType="Region">
        SELECT * FROM wvp_common_region
        WHERE device_id IN
        <foreach collection="regionList" item="item" open="(" separator="," close=")">
            #{item.deviceId}
        </foreach>
    </select>

    <!-- 按平台查询通道 -->
    <select id="queryByPlatform" resultType="CommonGBChannel">
        SELECT
            wcr.device_id AS gb_device_id,
            wcr.name AS gb_name
        FROM wvp_common_region wcr
                 LEFT JOIN wvp_platform_region wpr ON wcr.id = wpr.region_id
        WHERE wpr.platform_id = #{platformId}
    </select>

    <!-- 更新父节点ID (PostgreSQL专用) -->
    <update id="updateParentId">
        UPDATE wvp_common_region w1
        SET parent_id = w2.id
        FROM wvp_common_region w2
        WHERE w1.parent_device_id = w2.device_id
        AND w1.id IN
        <foreach collection="regionListForAdd" item="item" open="(" separator="," close=")">
            #{item.id}
        </foreach>
    </update>

    <!-- 更新子节点父设备ID -->
    <update id="updateChild">
        UPDATE wvp_common_region
        SET parent_device_id = #{parentDeviceId}
        WHERE parent_id = #{parentId}
    </update>

    <!-- 根据设备ID查询区域 -->
    <select id="queryByDeviceId" resultType="Region">
        SELECT * FROM wvp_common_region
        WHERE device_id = #{deviceId}
    </select>

    <!-- 查询父区域 -->
    <select id="queryParentInChannelList" resultType="Region">
        SELECT * FROM wvp_common_region
        WHERE id IN
        <foreach collection="regionSet" item="item" open="(" separator="," close=")">
            #{item.parentId}
        </foreach>
    </select>

    <!-- 根据通道列表查询区域 -->
    <select id="queryByChannelList" resultType="Region">
        SELECT * FROM wvp_common_region
        WHERE device_id IN
        <foreach collection="channelList" item="item" open="(" separator="," close=")">
            #{item.gbCivilCode}
        </foreach>
        ORDER BY id
    </select>

    <!-- 查询未共享区域（通过通道列表） -->
    <select id="queryNotShareRegionForPlatformByChannelList" resultType="Region">
        SELECT wcr.*
        FROM wvp_common_region wcr
        LEFT JOIN wvp_platform_region wpr
        ON wpr.region_id = wcr.id AND wpr.platform_id = #{platformId}
        WHERE wpr.platform_id IS NULL
        AND wcr.device_id IN
        <foreach collection="channelList" item="item" open="(" separator="," close=")">
            #{item.gbCivilCode}
        </foreach>
    </select>

    <!-- 查询未共享区域（通过区域列表） -->
    <select id="queryNotShareRegionForPlatformByRegionList" resultType="Region">
        SELECT wcr.*
        FROM wvp_common_region wcr
        LEFT JOIN wvp_platform_region wpr
        ON wpr.region_id = wcr.id AND wpr.platform_id = #{platformId}
        WHERE wpr.platform_id IS NULL
        AND wcr.id IN
        <foreach collection="allRegion" item="item" open="(" separator="," close=")">
            #{item.id}
        </foreach>
    </select>

    <!-- 查询行政区划码列表 -->
    <select id="queryInCivilCodePoList" resultType="string">
        SELECT device_id FROM wvp_common_region
        WHERE device_id IN
        <foreach collection="civilCodePoList" item="item" open="(" separator="," close=")">
            #{item.code}
        </foreach>
    </select>
</mapper>
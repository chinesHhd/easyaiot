<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.basiclab.iot.stream.mapper.GroupMapper">

    <!-- 添加分组 (返回自增ID) -->
    <insert id="add" parameterType="com.basiclab.iot.stream.bean.Group"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO wvp_common_group (
            device_id, name, parent_id, parent_device_id,
            business_group, create_time, update_time, civil_code
        ) VALUES (
                     #{deviceId}, #{name}, #{parentId}, #{parentDeviceId},
                     #{businessGroup}, #{createTime}, #{updateTime}, #{civilCode}
                 )
    </insert>

    <!-- 添加业务分组 (返回自增ID) -->
    <insert id="addBusinessGroup" parameterType="com.basiclab.iot.stream.bean.Group"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO wvp_common_group (
            device_id, name, business_group, create_time, update_time, civil_code
        ) VALUES (
                     #{deviceId}, #{name}, #{businessGroup}, #{createTime}, #{updateTime}, #{civilCode}
                 )
    </insert>

    <!-- 删除分组 -->
    <delete id="delete">
        DELETE FROM wvp_common_group WHERE id = #{id}
    </delete>

    <!-- 更新分组 -->
    <update id="update" parameterType="com.basiclab.iot.stream.bean.Group">
        UPDATE wvp_common_group
        SET update_time = #{updateTime},
            device_id = #{deviceId},
            name = #{name},
            parent_id = #{parentId},
            parent_device_id = #{parentDeviceId},
            business_group = #{businessGroup},
            civil_code = #{civilCode}
        WHERE id = #{id}
    </update>

    <!-- 条件查询分组 -->
    <select id="query" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT * FROM wvp_common_group
        WHERE 1=1
        <if test="query != null and query != ''">
            AND (device_id LIKE '%' || #{query} || '%' OR name LIKE '%' || #{query} || '%')
        </if>
        <if test="parentId != null and businessGroup != null">
            AND parent_device_id = #{parentId} AND business_group = #{businessGroup}
        </if>
        ORDER BY id
    </select>

    <!-- 获取子分组 -->
    <select id="getChildren" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT * FROM wvp_common_group WHERE parent_id = #{parentId}
    </select>

    <!-- 查询单个分组 -->
    <select id="queryOne" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT * FROM wvp_common_group WHERE id = #{id}
    </select>

    <!-- 批量添加分组 (PostgreSQL优化) -->
    <insert id="batchAdd" parameterType="java.util.List"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO wvp_common_group (
        device_id, name, parent_device_id, parent_id,
        business_group, create_time, civil_code, update_time
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.deviceId}, #{item.name}, #{item.parentDeviceId}, #{item.parentId},
            #{item.businessGroup}, #{item.createTime}, #{item.civilCode}, #{item.updateTime}
            )
        </foreach>
    </insert>

    <!-- 树形结构查询 -->
    <select id="queryForTree" resultType="com.basiclab.iot.stream.bean.GroupTree">
        SELECT *,
        ('group' || id) AS tree_id,
        0 AS type,
        false AS is_leaf,
        'ON' AS status
        FROM wvp_common_group
        WHERE 1=1
        <choose>
            <when test="parentId != null">
                AND parent_id = #{parentId}
            </when>
            <otherwise>
                AND parent_id IS NULL
            </otherwise>
        </choose>
        <if test="query != null and query != ''">
            AND (device_id LIKE '%' || #{query} || '%' OR name LIKE '%' || #{query} || '%')
        </if>
    </select>

    <!-- 按业务组树形查询 -->
    <select id="queryForTreeByBusinessGroup" resultType="com.basiclab.iot.stream.bean.GroupTree">
        SELECT *,
        0 AS type,
        false AS is_leaf
        FROM wvp_common_group
        WHERE parent_id IS NOT NULL
        AND business_group = #{businessGroup}
        AND device_id != #{businessGroup}
        <if test="query != null and query != ''">
            AND (device_id LIKE '%' || #{query} || '%' OR name LIKE '%' || #{query} || '%')
        </if>
    </select>

    <!-- 业务组树形查询 -->
    <select id="queryBusinessGroupForTree" resultType="com.basiclab.iot.stream.bean.GroupTree">
        SELECT *,
        0 AS type,
        false AS is_leaf
        FROM wvp_common_group
        WHERE device_id = business_group
        <if test="query != null and query != ''">
            AND (device_id LIKE '%' || #{query} || '%' OR name LIKE '%' || #{query} || '%')
        </if>
    </select>

    <!-- 按设备ID和业务组查询 -->
    <select id="queryOneByDeviceId" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT * FROM wvp_common_group
        WHERE device_id = #{deviceId} AND business_group = #{businessGroup}
    </select>

    <!-- 批量删除分组 -->
    <delete id="batchDelete" parameterType="java.util.List">
        DELETE FROM wvp_common_group
        WHERE id IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.id}
        </foreach>
    </delete>

    <!-- 查询业务组 -->
    <select id="queryBusinessGroup" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT * FROM wvp_common_group
        WHERE device_id = #{businessGroup} AND business_group = #{businessGroup}
    </select>

    <!-- 按业务组查询 -->
    <select id="queryByBusinessGroup" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT * FROM wvp_common_group WHERE business_group = #{businessGroup}
    </select>

    <!-- 按业务组删除 -->
    <delete id="deleteByBusinessGroup">
        DELETE FROM wvp_common_group WHERE business_group = #{businessGroup}
    </delete>

    <!-- 更新子组信息 -->
    <update id="updateChild">
        UPDATE wvp_common_group
        SET parent_device_id = #{group.deviceId},
            business_group = #{group.businessGroup}
        WHERE parent_id = #{parentId}
    </update>

    <!-- 按设备ID列表查询 -->
    <select id="queryInGroupListByDeviceId" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT * FROM wvp_common_group
        WHERE device_id IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.deviceId}
        </foreach>
    </select>

    <!-- 按通道列表查询 -->
    <select id="queryInChannelList" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT * FROM wvp_common_group
        WHERE (device_id, business_group) IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            (#{item.gbParentId}, #{item.gbBusinessGroupId})
        </foreach>
    </select>

    <!-- 查询父组列表 -->
    <select id="queryParentInChannelList" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT * FROM wvp_common_group
        WHERE id IN
        <foreach collection="collection" item="item" open="(" separator="," close=")">
            #{item.parentId}
        </foreach>
    </select>

    <!-- 查询平台通道信息 -->
    <select id="queryForPlatform" resultType="com.basiclab.iot.stream.bean.CommonGBChannel">
        SELECT
            wcg.device_id AS gb_device_id,
            wcg.name AS gb_name,
            wcg.business_group AS gb_business_group_id,
            1 AS gb_parental,
            wcg.parent_device_id AS gb_parent_id
        FROM wvp_common_group wcg
                 LEFT JOIN wvp_platform_group wpg ON wpg.group_id = wcg.id
        WHERE wpg.platform_id = #{platformId}
    </select>

    <!-- 查询未共享的组 -->
    <select id="queryNotShareGroupForPlatformByChannelList" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT wcg.*
        FROM wvp_common_group wcg
        LEFT JOIN wvp_platform_group wpg
        ON wpg.group_id = wcg.id AND wpg.platform_id = #{platformId}
        WHERE wpg.platform_id IS NULL
        AND wcg.device_id IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.gbParentId}
        </foreach>
    </select>

    <!-- 查询未共享的组（通过组列表） -->
    <select id="queryNotShareGroupForPlatformByGroupList" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT wcg.*
        FROM wvp_common_group wcg
        LEFT JOIN wvp_platform_group wpg
        ON wpg.group_id = wcg.id AND wpg.platform_id = #{platformId}
        WHERE wpg.platform_id IS NULL
        AND wcg.id IN
        <foreach collection="collection" item="item" open="(" separator="," close=")">
            #{item.id}
        </foreach>
    </select>

    <!-- 按通道列表查询组 -->
    <select id="queryByChannelList" resultType="com.basiclab.iot.stream.bean.Group">
        SELECT *
        FROM wvp_common_group
        WHERE device_id IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.gbParentId}
        </foreach>
        ORDER BY id
    </select>

    <!-- 更新父ID (PostgreSQL专用) -->
    <update id="updateParentId" parameterType="java.util.List">
        UPDATE wvp_common_group w1
        SET parent_id = w2.id
        FROM wvp_common_group w2
        WHERE w1.parent_device_id = w2.device_id
        AND w1.id IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.id}
        </foreach>
    </update>

    <!-- 更新业务组父ID (PostgreSQL专用) -->
    <update id="updateParentIdWithBusinessGroup" parameterType="java.util.List">
        UPDATE wvp_common_group w1
        SET parent_id = w2.id
        FROM wvp_common_group w2
        WHERE w1.parent_device_id IS NULL
        AND w2.parent_device_id IS NULL
        AND w2.device_id = w2.business_group
        AND w1.business_group = w2.device_id
        AND w1.device_id != w1.business_group
        AND w1.id IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.id}
        </foreach>
    </update>

    <!-- 按组ID查询平台 -->
    <select id="queryForPlatformByGroupId" resultType="com.basiclab.iot.stream.bean.Platform">
        SELECT wp.*
        FROM wvp_platform_group wpg
                 LEFT JOIN wvp_platform wp ON wp.id = wpg.platform_id
        WHERE wpg.group_id = #{groupId}
    </select>

    <!-- 删除平台组关联 -->
    <delete id="deletePlatformGroup">
        DELETE FROM wvp_platform_group WHERE group_id = #{groupId}
    </delete>

</mapper>